<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>부가세 계산기</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f4f6f8;
      --card: #ffffff;
      --text: #1f2933;
      --muted: #52606d;
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --border: #d9e2ec;
      --focus: #0ea5e9;
      --danger: #b91c1c;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Pretendard", "Noto Sans KR", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px;
    }

    header {
      text-align: center;
      margin-bottom: 24px;
    }

    h1 {
      margin: 0;
      font-size: clamp(1.6rem, 2vw + 1.2rem, 2.4rem);
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      border: 1px solid var(--border);
      display: grid;
      gap: 24px;
    }

    .grid {
      display: grid;
      gap: 16px;
    }

    .grid.two {
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .section-title {
      font-weight: 700;
      font-size: 1rem;
    }

    .mode-toggle {
      display: flex;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .mode-toggle label {
      flex: 1;
      padding: 12px 16px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      background: #f8fafc;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .mode-toggle input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .mode-toggle input:checked + span {
      background: var(--primary);
      color: #fff;
    }

    label span {
      display: block;
    }

    .field {
      display: grid;
      gap: 8px;
    }

    .field label {
      font-weight: 600;
      color: var(--muted);
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 1rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background: #fff;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus,
    button:focus {
      outline: 3px solid rgba(14, 165, 233, 0.35);
      border-color: var(--focus);
    }

    .rate-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .helper {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .error {
      color: var(--danger);
      font-weight: 600;
      min-height: 1.2em;
    }

    .radio-group {
      display: grid;
      gap: 12px;
    }

    .radio-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }

    .results {
      background: #f8fafc;
      border-radius: 16px;
      padding: 20px;
      display: grid;
      gap: 16px;
      border: 1px solid var(--border);
    }

    .result-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .result-row .label {
      font-weight: 700;
    }

    .result-row .value {
      font-size: clamp(1.3rem, 2vw + 1rem, 2.1rem);
      font-weight: 700;
    }

    .result-row button {
      padding: 8px 12px;
      font-size: 0.9rem;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: flex-end;
    }

    button {
      border: none;
      background: var(--primary);
      color: #fff;
      padding: 12px 18px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    button:hover {
      background: var(--primary-dark);
    }

    button.secondary {
      background: #e2e8f0;
      color: #1e293b;
    }

    button.secondary:hover {
      background: #cbd5f5;
    }

    .copy-status {
      font-size: 0.85rem;
      color: var(--muted);
      min-height: 1.2em;
    }

    @media (max-width: 720px) {
      .rate-row {
        grid-template-columns: 1fr;
      }

      .result-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .button-row {
        justify-content: stretch;
      }

      .button-row button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!--
    부가세(VAT) 계산기 사용법
    1) 입력 모드를 선택하고 금액을 입력하면 실시간으로 계산됩니다.
    2) 부가세율은 기본 10%이며, 직접입력을 선택하면 소수점 세율을 사용할 수 있습니다.
    3) 결과 옆의 복사 버튼을 누르면 클립보드에 복사됩니다.
    4) "현재 값으로 링크 공유" 버튼으로 동일한 상태를 링크로 공유할 수 있습니다.
  -->
  <div class="container">
    <header>
      <h1>부가세 계산기</h1>
      <p class="helper">공급가액/합계 입력 모드를 전환하고 부가세율과 반올림 옵션을 설정하세요.</p>
    </header>

    <main class="card" aria-live="polite">
      <section class="grid">
        <div class="field">
          <span class="section-title">입력 모드</span>
          <div class="mode-toggle" role="tablist" aria-label="입력 모드 토글">
            <label>
              <input type="radio" name="mode" value="supply" checked />
              <span role="tab" aria-selected="true">공급가액(세전) 입력</span>
            </label>
            <label>
              <input type="radio" name="mode" value="total" />
              <span role="tab" aria-selected="false">합계(세후) 입력</span>
            </label>
          </div>
        </div>

        <div class="field">
          <label for="amount-input">금액 입력</label>
          <input
            id="amount-input"
            type="text"
            inputmode="decimal"
            placeholder="예: 1,000,000"
            aria-label="금액 입력"
          />
          <div id="amount-error" class="error" aria-live="assertive"></div>
        </div>

        <div class="grid two">
          <div class="field">
            <label for="rate-select">부가세율 선택</label>
            <div class="rate-row">
              <select id="rate-select" aria-label="부가세율 선택">
                <option value="0">0%</option>
                <option value="1">1%</option>
                <option value="3">3%</option>
                <option value="5">5%</option>
                <option value="7">7%</option>
                <option value="10" selected>10%</option>
                <option value="12">12%</option>
                <option value="15">15%</option>
                <option value="20">20%</option>
                <option value="custom">직접입력</option>
              </select>
              <input
                id="rate-custom"
                type="number"
                min="0"
                max="100"
                step="0.1"
                disabled
                placeholder="직접 입력 (%)"
                aria-label="부가세율 직접입력"
              />
            </div>
            <p class="helper">0~100% 범위의 소수 세율을 허용합니다.</p>
          </div>

          <div class="field">
            <span class="section-title">반올림 옵션</span>
            <div class="radio-group" role="radiogroup" aria-label="반올림 옵션">
              <label>
                <input type="radio" name="rounding" value="round" checked />
                원단위 반올림
              </label>
              <label>
                <input type="radio" name="rounding" value="floor" />
                원단위 절사(버림)
              </label>
              <label>
                <input type="radio" name="rounding" value="ceil" />
                원단위 올림
              </label>
            </div>
          </div>
        </div>
      </section>

      <section class="results" aria-label="계산 결과">
        <div class="result-row">
          <div>
            <div class="label">공급가액(세전)</div>
            <div class="value" id="result-supply">-</div>
          </div>
          <button class="secondary" type="button" data-copy="supply" aria-label="공급가액 복사">
            복사
          </button>
        </div>
        <div class="result-row">
          <div>
            <div class="label">부가세</div>
            <div class="value" id="result-vat">-</div>
          </div>
          <button class="secondary" type="button" data-copy="vat" aria-label="부가세 복사">
            복사
          </button>
        </div>
        <div class="result-row">
          <div>
            <div class="label">합계(세후)</div>
            <div class="value" id="result-total">-</div>
          </div>
          <button class="secondary" type="button" data-copy="total" aria-label="합계 복사">
            복사
          </button>
        </div>
        <div class="copy-status" id="copy-status" aria-live="polite"></div>
      </section>

      <section class="button-row">
        <button class="secondary" type="button" id="reset-button">초기화</button>
        <button class="secondary" type="button" id="share-button">현재 값으로 링크 공유</button>
      </section>
    </main>
  </div>

  <script>
    const modeInputs = document.querySelectorAll('input[name="mode"]');
    const roundingInputs = document.querySelectorAll('input[name="rounding"]');
    const amountInput = document.getElementById('amount-input');
    const amountError = document.getElementById('amount-error');
    const rateSelect = document.getElementById('rate-select');
    const rateCustom = document.getElementById('rate-custom');
    const resultSupply = document.getElementById('result-supply');
    const resultVat = document.getElementById('result-vat');
    const resultTotal = document.getElementById('result-total');
    const copyStatus = document.getElementById('copy-status');
    const resetButton = document.getElementById('reset-button');
    const shareButton = document.getElementById('share-button');

    const MAX_AMOUNT = 999999999999;
    const CUSTOM_RATE_KEY = 'custom';

    const formatCurrency = (value) => {
      if (value === null) {
        return '-';
      }
      return `${value.toLocaleString('ko-KR')}원`;
    };

    const sanitizeNumberInput = (value) => {
      if (!value) {
        return '';
      }
      return value.replace(/[^
\d.,]/g, '');
    };

    const parseAmount = (value) => {
      if (!value) {
        return null;
      }
      const sanitized = value.replace(/,/g, '');
      if (!/^\d*(\.\d+)?$/.test(sanitized)) {
        return NaN;
      }
      const numberValue = Number(sanitized);
      if (!Number.isFinite(numberValue)) {
        return NaN;
      }
      return numberValue;
    };

    const getRatePercent = () => {
      if (rateSelect.value === CUSTOM_RATE_KEY) {
        return Number(rateCustom.value);
      }
      return Number(rateSelect.value);
    };

    const applyRounding = (value, method) => {
      if (!Number.isFinite(value)) {
        return 0;
      }
      switch (method) {
        case 'floor':
          return Math.floor(value);
        case 'ceil':
          return Math.ceil(value);
        default:
          return Math.round(value);
      }
    };

    const preciseMultiply = (amount, ratePercent) => {
      const scaledRate = Math.round(ratePercent * 10000); // percent to 1e4 scale
      return (amount * scaledRate) / 10000 / 100;
    };

    const preciseDivide = (amount, ratePercent) => {
      const scaledRate = Math.round(ratePercent * 10000);
      const denominator = 10000 * 100 + scaledRate;
      return (amount * 10000 * 100) / denominator;
    };

    const getCurrentMode = () =>
      document.querySelector('input[name="mode"]:checked').value;

    const getRounding = () =>
      document.querySelector('input[name="rounding"]:checked').value;

    const updateModeTabs = () => {
      const spans = document.querySelectorAll('.mode-toggle span');
      spans.forEach((span) => {
        const input = span.parentElement.querySelector('input');
        span.setAttribute('aria-selected', input.checked ? 'true' : 'false');
      });
    };

    const showError = (message) => {
      amountError.textContent = message || '';
    };

    const validateRate = (ratePercent) => {
      if (!Number.isFinite(ratePercent)) {
        return false;
      }
      return ratePercent >= 0 && ratePercent <= 100;
    };

    const formatInputDisplay = (value) => {
      if (value === null || value === undefined || value === '') {
        return '';
      }
      const sanitized = value.replace(/,/g, '');
      if (!/^\d*(\.\d+)?$/.test(sanitized)) {
        return value;
      }
      const [integerPart, decimalPart] = sanitized.split('.');
      const formattedInt = Number(integerPart || '0').toLocaleString('ko-KR');
      return decimalPart ? `${formattedInt}.${decimalPart}` : formattedInt;
    };

    const calculate = () => {
      const rawValue = amountInput.value.trim();
      if (!rawValue) {
        resultSupply.textContent = '-';
        resultVat.textContent = '-';
        resultTotal.textContent = '-';
        showError('금액을 입력하세요');
        return;
      }

      const amount = parseAmount(rawValue);
      if (Number.isNaN(amount)) {
        showError('숫자만 입력하세요');
        return;
      }
      if (amount < 0) {
        showError('음수는 입력할 수 없습니다');
        return;
      }
      if (amount > MAX_AMOUNT) {
        showError('최대 999,999,999,999까지 입력 가능합니다');
        return;
      }

      const ratePercent = getRatePercent();
      if (!validateRate(ratePercent)) {
        showError('부가세율은 0~100% 사이여야 합니다');
        return;
      }

      const rounding = getRounding();
      const rate = ratePercent / 100;
      let supply = 0;
      let vat = 0;
      let total = 0;

      if (getCurrentMode() === 'supply') {
        supply = amount;
        vat = preciseMultiply(supply, ratePercent);
        vat = applyRounding(vat, rounding);
        total = applyRounding(supply + vat, rounding);
      } else {
        total = amount;
        supply = preciseDivide(total, ratePercent);
        supply = applyRounding(supply, rounding);
        vat = applyRounding(total - supply, rounding);
      }

      showError('');
      resultSupply.textContent = formatCurrency(supply);
      resultVat.textContent = formatCurrency(vat);
      resultTotal.textContent = formatCurrency(total);
    };

    let debounceTimer;
    const scheduleCalculate = () => {
      window.clearTimeout(debounceTimer);
      debounceTimer = window.setTimeout(calculate, 150);
    };

    const syncRateInput = () => {
      if (rateSelect.value === CUSTOM_RATE_KEY) {
        rateCustom.disabled = false;
        rateCustom.focus();
      } else {
        rateCustom.disabled = true;
        rateCustom.value = '';
      }
    };

    const handleCopy = async (target) => {
      const textMap = {
        supply: resultSupply.textContent.replace('원', ''),
        vat: resultVat.textContent.replace('원', ''),
        total: resultTotal.textContent.replace('원', ''),
      };
      const text = textMap[target];
      if (!text || text === '-') {
        copyStatus.textContent = '복사할 값이 없습니다.';
        return;
      }
      try {
        await navigator.clipboard.writeText(text);
        copyStatus.textContent = '복사되었습니다.';
      } catch (error) {
        copyStatus.textContent = '복사에 실패했습니다.';
      }
    };

    const resetAll = () => {
      amountInput.value = '';
      rateSelect.value = '10';
      rateCustom.value = '';
      rateCustom.disabled = true;
      modeInputs[0].checked = true;
      roundingInputs[0].checked = true;
      updateModeTabs();
      showError('');
      resultSupply.textContent = '-';
      resultVat.textContent = '-';
      resultTotal.textContent = '-';
      copyStatus.textContent = '';
      scheduleCalculate();
    };

    const updateShareLink = () => {
      const params = new URLSearchParams();
      const mode = getCurrentMode();
      const amount = amountInput.value.trim();
      const rateValue = rateSelect.value;
      const rateCustomValue = rateCustom.value.trim();
      const rounding = getRounding();

      params.set('mode', mode);
      params.set('amount', amount);
      params.set('rate', rateValue);
      if (rateValue === CUSTOM_RATE_KEY) {
        params.set('rateCustom', rateCustomValue);
      }
      params.set('rounding', rounding);

      const url = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
      navigator.clipboard.writeText(url).then(
        () => {
          copyStatus.textContent = '링크가 복사되었습니다.';
        },
        () => {
          copyStatus.textContent = '링크 복사에 실패했습니다.';
        }
      );
    };

    const restoreFromQuery = () => {
      const params = new URLSearchParams(window.location.search);
      const mode = params.get('mode');
      const amount = params.get('amount');
      const rate = params.get('rate');
      const rateCustomValue = params.get('rateCustom');
      const rounding = params.get('rounding');

      if (mode === 'total') {
        modeInputs[1].checked = true;
      }
      if (rounding) {
        const roundingInput = document.querySelector(`input[name="rounding"][value="${rounding}"]`);
        if (roundingInput) {
          roundingInput.checked = true;
        }
      }
      if (rate) {
        rateSelect.value = rate;
      }
      syncRateInput();
      if (rateSelect.value === CUSTOM_RATE_KEY && rateCustomValue) {
        rateCustom.value = rateCustomValue;
      }
      if (amount) {
        amountInput.value = formatInputDisplay(amount);
      }
      updateModeTabs();
      scheduleCalculate();
    };

    amountInput.addEventListener('input', (event) => {
      const sanitized = sanitizeNumberInput(event.target.value);
      event.target.value = formatInputDisplay(sanitized);
      scheduleCalculate();
    });

    modeInputs.forEach((input) => {
      input.addEventListener('change', () => {
        updateModeTabs();
        scheduleCalculate();
      });
    });

    roundingInputs.forEach((input) => {
      input.addEventListener('change', scheduleCalculate);
    });

    rateSelect.addEventListener('change', () => {
      syncRateInput();
      scheduleCalculate();
    });

    rateCustom.addEventListener('input', scheduleCalculate);

    document.querySelectorAll('[data-copy]').forEach((button) => {
      button.addEventListener('click', (event) => {
        handleCopy(event.currentTarget.dataset.copy);
      });
    });

    resetButton.addEventListener('click', resetAll);
    shareButton.addEventListener('click', updateShareLink);

    restoreFromQuery();

    // 테스트 케이스
    // 공급가액 1,000,000 / 10% -> 부가세 100,000 / 합계 1,100,000
    // 합계 1,100,000 / 10% -> 공급가 1,000,000 / 부가세 100,000
    // 공급가액 9,999,999 / 10%에서 반올림/절사/올림 비교
    // 세율 3.3% 같은 소수 세율 직접입력 케이스

    // 수동 테스트 체크리스트
    // [ ] 입력 모드 전환 시 결과가 올바르게 변경되는지 확인
    // [ ] 부가세율 직접입력 선택 시 입력칸 활성화 여부 확인
    // [ ] 반올림 옵션별 결과 차이 확인
    // [ ] 복사 버튼 클릭 시 클립보드 복사 확인
    // [ ] 링크 공유 후 새로고침 시 상태 복원 확인
  </script>
</body>
</html>
